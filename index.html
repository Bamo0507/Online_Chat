<html>
  <head>
  </head>
  <body>
    <script type="application/javascript">
        // /////////////////////////////////////////////////////////////////////////////////
        // Title
        const title = document.createElement('title');
        title.textContent = 'Ping/Pong';
        document.head.appendChild(title);
        // /////////////////////////////////////////////////////////////////////////////////
        // Generar style
        const styleElement = document.createElement('style');
        styleElement.innerHTML = `
          /* Importar otro tipo de FONT */
            @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Tektur:wght@400..900&display=swap');

            /* Variables */
            :root {
                --background-color: #deebf7;

                --background-header: #151e3d;

                --primary-color: #007aa2;
                --secondary-color: #86beda;
                --tertiary-color: #f5fbff;

                --error-color: #950606;

                --white-color: #fff;

                /* Font Weight */
                --font-weight-normal: 400;
                --font-weight-medium: 500;
                --font-weight-semibold: 600;
                --font-weight-bold: 700;


                /* Font size */
                --font-size-s: 0.9rem;
                --font-size-n: 1rem;
                --font-size-m: 1.12rem;
                --font-size-l: 1.5rem;
                --font-size-xl: 2rem;
                --font-size-xxl: 2.6rem;

                /* Border radius */
                --border-radius-s: 8px;
                --border-radius-m: 30px;
                --border-radius-circle: 50%;

                /* Site max width */
                --site-max-width: 1300px;
            }
            /* ----------------------------------- */

            /* Styles 4 the Entire Page */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: "Poppins", serif;
            }

            /* Body para el background */
            body {
                background: var(--background-color)
            }

            /* Como quiero que me ordene todo lo del main */
            main {
                display: flex;
                flex-direction: column;
                align-items: center;
                max-height: 82%;
            }

            ul {
                list-style: none;
            }

            a {
                text-decoration: none;
            }

            button {
                cursor: pointer;
                border: none;
                background: none;
            }
            /* ------------------------------------------ */

            /* Background */
            body {
                background: var(--background-color);
            }

            /* Header */
            header {
                background-color: var(--background-header);
                color: var(--white-color);
                text-align: center;
                height: 15vmin;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: var(--font-size-xxl);
                padding: 4rem;
            }

            header h1 {
                font-family: "Tektur", serif;
                text-align: center;
                text-transform: uppercase;
                font-weight: var(--font-weight-bold);
                margin: 0;
            }

            /* Main */
            /* Mensajes */
            .mensajes {
                background-color: var(--tertiary-color);
                border-radius: var(--border-radius-m);
                height: 40vmin;
                width: 80vmin;
                margin: 30px 20px;
                padding: 20px;
                border: 2px solid var(--primary-color);

                max-height: 40vmin;

                display: flex;
                flex-direction: column;
                justify-content: flex-end;
            }

            /* Enviar texto */
            .enviar_texto {
                flex-direction: column;
                justify-content: start;
                align-items: start;
                height: 50vmin;
                width: 80vmin;
                margin: 0px 20px;
            }
            
            .enviar_texto h2 {
                font-size: var(--font-size-l);
                font-weight: var(--font-weight-bold);
                margin-bottom: 5px;
            }

            .enviar_texto p {
                font-size: var(--font-size-m);
                font-weight: var(--font-weight-semibold);
                margin-top: 20px;
                margin-bottom: 10px;
            }
            
            .enviar_texto .texto {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }
            
            input {
                width: 65%;
                height: 50px;
                border-radius: var(--border-radius-s);
                border: 2px solid var(--primary-color);
                padding: 0 10px;
                font-size: var(--font-size-m);
                font-weight: var(--font-weight-medium);

                transition: 0.5s ease;
            }

            input:focus {
                outline: none;
                border: 2px solid var(--secondary-color);
            }
            
            .enviar_texto .texto button {
                width: 32%;
                height: 50px;
                border-radius: var(--border-radius-s);
                background-color: var(--primary-color);
                color: var(--white-color);
                font-size: var(--font-size-m);
                font-weight: var(--font-weight-bold);

                transition: 0.5s ease;
            }

            .enviar_texto .texto button:hover {
                background-color: var(--secondary-color);
                color: var(--header-background);
            }
            
            /* Mensaje de error */
            .enviar_texto #mensajeError {
                display: none;
                color: var(--error-color);
                font-size: var(--font-size-s);
                font-weight: var(--font-weight-bold);
                margin-top: 5px;
                transition: 0.5s ease;
            }

            /* Diseño de cada elemento que entre a la lista */
            #lista-mensajes::-webkit-scrollbar {
                margin-left: 50px;
                width: 10px;
            }

            #lista-mensajes::-webkit-scrollbar-track {
                background: var(--secondary-color);
            }
            
            #lista-mensajes::-webkit-scrollbar-thumb {
                background-color: var(--primary-color);
                border-radius: var(--border-radius-m);
            }

            #lista-mensajes {
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                padding: 0 1rem 0 0; /* Deja espacio a la derecha */
                list-style-type: none;
                box-sizing: border-box; /* Importante para que el padding no sume ancho extra */
                justify-content: center;
            }

            #lista-mensajes li {
                background: var(--secondary-color);
                border-radius: var(--border-radius-m);
                padding: 10px;
                padding-left: 20px;
                margin: 10px 0;
                font-size: var(--font-size-n);
                font-weight: var(--font-weight-semibold);
                width: 100%;
                white-space: normal;
                overflow-wrap: break-word;
            }
            
            #lista-mensajes img {
                max-width: 40%;
                border-radius: var(--border-radius-m);
            }

        `;
        document.head.appendChild(styleElement);
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        

        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Generar main
        const mainElement = document.createElement('main');
        mainElement.innerHTML = `
            <div class="mensajes">
                <ul id="lista-mensajes"></ul>
            </div>

            <div class="enviar_texto">
                <h2>Text Input</h2>

                <input type="text" id="username" placeholder="Username">

                <p>Cantidad de Caracteres: </p>

                <div class="texto">
                    <input type="text" id="texto" placeholder="Hello World!">
                    <button id="enviar">Enviar</button>
                </div>
                <span id="mensajeError">Maximo 140 caracteres!</span>
                
            </div>
        `;
        document.body.appendChild(mainElement);
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Referencias a inputs
        const usernameInput = document.getElementById('username');
        const input = document.getElementById('texto');
        const mensajeError = document.getElementById('mensajeError');
        const cant_caracteres = document.querySelector('.enviar_texto p');
        const enviar = document.getElementById('enviar');
        const maxCaracteres = 140;
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Limitar caracteres
        input.addEventListener('input', () => {
            cant_caracteres.innerHTML = `Cantidad de Caracteres: ${input.value.length}`;
            if (input.value.length > maxCaracteres) {
                mensajeError.style.display = 'inline';
                input.value = input.value.slice(0, maxCaracteres);
            } else {
                mensajeError.style.display = 'none';
            }
        });

        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Función para renderizar el mensaje en la UI
        function renderMensaje(username, texto) {
            const listaMensajes = document.getElementById('lista-mensajes');
            const nuevoMensaje = document.createElement('li');

            const usernameElement = document.createElement('span');
            usernameElement.textContent = username;
            usernameElement.style.fontWeight = 'bold';

            const saltoLinea = document.createElement('br');

            const mensajeElement = document.createElement('span');
            mensajeElement.style.display = 'block';
            mensajeElement.style.color = 'white';

            if (/\.(jpe?g|png|gif)$/i.test(texto)) {
            const imagen = document.createElement('img');
            imagen.src = texto;
            imagen.style.maxWidth = '40%';
            mensajeElement.appendChild(imagen);
            } else {
            mensajeElement.textContent = texto;
            }

            nuevoMensaje.appendChild(usernameElement);
            nuevoMensaje.appendChild(saltoLinea);
            nuevoMensaje.appendChild(mensajeElement);

            listaMensajes.appendChild(nuevoMensaje);
            listaMensajes.scrollTop = listaMensajes.scrollHeight;
        }
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Función para validar que ambos campos tengan contenido
        function validateInput() {
            const usernameValue = usernameInput.value.trim();
            const messageValue = input.value.trim();

            if (usernameValue !== '' && messageValue !== '') {
                enviarMensaje(usernameValue, messageValue);
                input.value = '';
                cant_caracteres.innerHTML = `Cantidad de Caracteres: 0`;
            }
        }
        
        enviar.addEventListener('click', validateInput);

        input.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                validateInput();
            }
        });
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Extraer mensajes del api
        async function obtenerMensajes() {
            const response = await fetch('https://chat.nrywhite.lat/chats');
            const data = await response.json();

            console.log(data);
            // Deconstruccion de lo que viene en el json, no se toma en cuenta el ID
            data.forEach(({ username, message }) => {
                renderMensaje(username, message);
            });
        }
      
      // Cargar mensajes cada 5 segundos
      setInterval(obtenerMensajes, 5000);
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Agregar mensaje a la lista con usuario y mensaje al api
        // Función para enviar mensaje al API y renderizarlo
        async function enviarMensaje(username, texto) {
            const response = await fetch('https://chat.nrywhite.lat/chats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, message: texto })
            });

            if (response.status === 201) {
                console.log('Mensaje enviado con éxito');
                renderMensaje(username, texto);
            } else {
                console.error('Error al enviar el mensaje');
            }
        }
        // /////////////////////////////////////////////////////////////////////////////////
 
    </script>
  </body>
</html>