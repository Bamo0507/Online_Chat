<html>
  <head>
  </head>
  <body>
    <script type="application/javascript">
        // /////////////////////////////////////////////////////////////////////////////////
        // Title
        const title = document.createElement('title');
        title.textContent = 'Ping/Pong';
        document.head.appendChild(title);
        // UTF-8
        const charset = document.createElement('meta');
        charset.setAttribute('charset', 'UTF-8');
        document.head.appendChild(charset);
        // viewport
        const viewport = document.createElement('meta');
        viewport.setAttribute('name', 'viewport');
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
        document.head.appendChild(viewport);
        // /////////////////////////////////////////////////////////////////////////////////
        // Generar style
        const styleElement = document.createElement('style');
        styleElement.innerHTML = `
          /* Importar otro tipo de FONT */
            @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Share+Tech+Mono&display=swap');

            /* Variables */
            :root {
                --background-color: #deebf7;

                --background-header: #151e3d;

                --primary-color: #007aa2;
                --secondary-color: #86beda;
                --tertiary-color: #f5fbff;

                --username-color: #003f5d;

                --even-msg-color: #c5d4eb;

                --error-color: #950606;

                --white-color: #fff;

                /* Font Weight */
                --font-weight-normal: 400;
                --font-weight-medium: 500;
                --font-weight-semibold: 600;
                --font-weight-bold: 700;


                /* Font size */
                --font-size-s: 0.9rem;
                --font-size-n: 1rem;
                --font-size-m: 1.12rem;
                --font-size-l: 1.5rem;
                --font-size-xl: 2rem;
                --font-size-xxl: 2.6rem;

                /* Border radius */
                --border-radius-s: 8px;
                --border-radius-m: 30px;
                --border-radius-circle: 50%;

                /* Site max width */
                --site-max-width: 1300px;
            }
            /* ----------------------------------- */

            /* Styles 4 the Entire Page */
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: "Share Tech Mono", monospace;
            }

            /* Body para el background */
            body {
                background: var(--background-color)
            }

            /* Como quiero que me ordene todo lo del main */
            main {
                display: flex;
                flex-direction: column;
                align-items: center;
                max-height: 82%;
            }

            ul {
                list-style: none;
            }

            a {
                text-decoration: none;
            }

            button {
                cursor: pointer;
                border: none;
                background: none;
            }
            /* ------------------------------------------ */

            /* Background */
            body {
                background: var(--background-color);
            }

            /* Header */
            header {
                background-color: var(--background-header);
                color: var(--white-color);
                text-align: center;
                height: 15vmin;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: var(--font-size-xxl);
                padding: 4rem;
            }

            header h1 {
                font-family: "Press Start 2P";
                font-size: var(--font-size-xxl);
                text-align: center;
                text-transform: uppercase;
                font-weight: var(--font-weight-bold);
                margin: 0;
            }
            
            /* Animacion Header */
            #typewriter {
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: baseline;
            }

            /* Cursor parpadeante */
            .cursor {
                display: inline-block;
                height: 1em;        
                width: 0.2em;       
                background-color: var(--primary-color);
                animation: blink 0.6s steps(1) infinite;
                margin-left: 3px;
                vertical-align: text-bottom; 
            }

            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0; }
                100% { opacity: 1; }
            }

            /* Main */
            /* Mensajes */
            .mensajes {
                background-color: var(--tertiary-color);
                border-radius: var(--border-radius-s);
                height: 40vmin;
                width: 80vmin;
                margin: 10px 20px;
                margin-top: 20px;
                padding: 20px;
                border: 2px solid var(--primary-color);

                max-height: 40vmin;

                display: flex;
                flex-direction: column;
                justify-content: flex-end;
            }

            /* Enviar texto */
            .enviar_texto {
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 50vmin;
                width: 80vmin;
                margin: 0px 20px;
            }
            
            .enviar_texto h2 {
                text-align: center;
                font-size: var(--font-size-xl);
                font-weight: var(--font-weight-bold);
                margin: 0;
                padding: 0;
            }

            .enviar_texto .texto p {
                font-size: var(--font-size-m);
                font-weight: var(--font-weight-semibold);
                margin-top: 20px;
                margin-bottom: 10px;
            }
            
            .enviar_texto .texto {
                display: flex;
                flex-direction: column;
                
            }
            
            input {
                width: 65%;
                height: 50px;
                border-radius: var(--border-radius-s);
                border: 2px solid var(--primary-color);
                padding: 0 10px;
                font-size: var(--font-size-m);
                font-weight: var(--font-weight-medium);
                margin: 20px 0 0 0;
                transition: 0.5s ease;
            }

            input:focus {
                outline: none;
                border: 2px solid var(--secondary-color);
            }
            
            .enviar_texto .texto button {
                width: 32%;
                height: 50px;
                border-radius: var(--border-radius-s);
                background-color: var(--primary-color);
                color: var(--white-color);
                font-size: var(--font-size-m);
                font-weight: var(--font-weight-bold);
                margin: 10px 0 0 0;
                transition: 0.5s ease;
            }

            .enviar_texto .texto button:hover {
                background-color: var(--secondary-color);
                color: var(--header-background);
            }
            
            /* Mensaje de error */
            .enviar_texto #mensajeError {
                display: none;
                color: var(--error-color);
                font-size: var(--font-size-m);
                font-weight: var(--font-weight-bold);
                margin-top: 5px;
                transition: 0.5s ease;
            }

            /* Dise√±o de cada elemento que entre a la lista */
            #lista-mensajes::-webkit-scrollbar {
                margin-left: 50px;
                width: 10px;
            }

            #lista-mensajes::-webkit-scrollbar-track {
                background: var(--secondary-color);
            }
            
            #lista-mensajes::-webkit-scrollbar-thumb {
                background-color: var(--primary-color);
                border-radius: var(--border-radius-m);
            }

            #lista-mensajes {
                display: flex;
                flex-direction: column;
                overflow-y: auto;
                padding: 0 1rem 0 0; /* Deja espacio a la derecha */
                list-style-type: none;
                box-sizing: border-box; /* Importante para que el padding no sume ancho extra */
                justify-content: center;
            }

            #lista-mensajes li {
                border-radius: var(--border-radius-m);
                padding: 20px 30px;
                margin: 10px 0;
                font-size: var(--font-size-n);
                font-weight: var(--font-weight-semibold);
                width: 100%;
                white-space: normal;
                overflow-wrap: break-word;
            }
            
            #lista-mensajes img {
                max-width: 40%;
                border-radius: var(--border-radius-m);
            }
            
            #lista-mensajes li:nth-child(2n) {
                background-color: var(--even-msg-color);
                text-align: right;
            }

            #lista-mensajes li:nth-child(2n+1) {
                background-color: var(--secondary-color);
                text-align: left;
            }

            #lista-mensajes li:nth-child(2n+1) .mensaje_element {
                color: var(--white-color);
            }

            #lista-mensajes li:nth-child(2n) .mensaje_element {
                color: var(--header-background);
            }

            /* Media Queries */
            @media (max-width: 640px) {
                /* Esconder la scrollbar */
                #lista-mensajes::-webkit-scrollbar {
                    display: none;
                }

                #lista-mensajes {
                    padding: 0 0 0 0; 
                }

                /* tama√±o de header */
                header h1 {
                    font-size: var(--font-size-xl);
                }
                
                /* Aumentar tama√±o lista */
                .mensajes {
                    height: 55vmin;
                    max-height: 55vmin;
                    font-size: var(--font-size-m);
                }

                .mensajes #lista-mensajes li {
                    font-size: var(--font-size-s);
                    padding: 15px 20px;
                    margin: 5px 0;
                }

                /* Menor tama√±o en texto */
                .enviar_texto h2 {
                    font-size: var(--font-size-l);
                }

                /* Menor tama√±o en campo de texto */
                .enviar_texto input {
                    width: 100%;
                    font-size: var(--font-size-s);
                }

                .enviar_texto .texto p {
                    font-size: var(--font-size-s);
                }

                .enviar_texto #mensajeError {
                    font-size: var(--font-size-s);
                }

                .enviar_texto .texto button {
                    width: 100%;
                    font-size: var(--font-size-s);
                }
            }
        `;
        document.head.appendChild(styleElement);
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Generar header
        const headerElement = document.createElement('header');
        headerElement.innerHTML = `
            <div id = "typewriter"></div>
        `;
        document.body.appendChild(headerElement);

        //Texto fijo
        const texto_fijo = "PING";
        //Texto dinamico
        const texto_dinamico = "/PONG";

        //Tiempo entre letrea
        const intervalo = 800;

        const typewriter = document.getElementById("typewriter");

        //Fijo
        const h1_fijo = document.createElement("h1");
        h1_fijo.textContent = texto_fijo;
        h1_fijo.style.color = "var(--white-color)";
        typewriter.appendChild(h1_fijo);

        //Dinamico
        const h1_dinamico = document.createElement("h1");
        h1_dinamico.style.color = "var(--primary-color)";
        typewriter.appendChild(h1_dinamico);

        // Cursor
        const cursor = document.createElement("h1");
        cursor.classList.add("cursor");
        typewriter.appendChild(cursor);

        let currentIndex = 0;

        function typeLetter() {
            if (currentIndex < texto_dinamico.length) {
                h1_dinamico.textContent += texto_dinamico[currentIndex];
                currentIndex++;
                setTimeout(typeLetter, intervalo);
            } 
        }

        typeLetter();

        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Generar main
        const mainElement = document.createElement('main');
        mainElement.innerHTML = `
            <div class="mensajes">
                <ul id="lista-mensajes"></ul>
            </div>

            <div class="enviar_texto">
                <h2>Nuevo Mensaje</h2>

                <input type="text" id="username" placeholder="Username">

                <div class="texto">
                    <input type="text" id="texto" placeholder="Hello World!">
                    <p>Cantidad de Caracteres: 0</p>
                    <p id="mensajeError">Maximo 140 caracteres!</p>
                    <button id="enviar">Enviar</button>
                </div>
                
            </div>
        `;
        document.body.appendChild(mainElement);
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Referencias a inputs
        const usernameInput = document.getElementById('username');
        const input = document.getElementById('texto');
        const mensajeError = document.getElementById('mensajeError');
        const cant_caracteres = document.querySelector('.enviar_texto .texto p');
        const enviar = document.getElementById('enviar');
        const maxCaracteres = 140;
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Limitar caracteres
        input.addEventListener('input', () => {
            cant_caracteres.innerHTML = `Cantidad de Caracteres: ${input.value.length}`;
            if (input.value.length > maxCaracteres) {
                cant_caracteres.innerHTML = `Cantidad de Caracteres: ${maxCaracteres}`;
                mensajeError.style.display = 'inline';
                input.value = input.value.slice(0, maxCaracteres);
            } else {
                mensajeError.style.display = 'none';
            }
        });

        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Funci√≥n para renderizar el mensaje en la UI
        function renderMensaje(username, texto) {
            const listaMensajes = document.getElementById('lista-mensajes');
            const nuevoMensaje = document.createElement('li');

            const usernameElement = document.createElement('span');
            usernameElement.textContent = username;
            usernameElement.style.fontWeight = 'bold';
            usernameElement.style.color = 'var(--username-color)';
            usernameElement.style.textTransform = 'uppercase';

            const saltoLinea = document.createElement('br');

            const mensajeElement = document.createElement('span');
            mensajeElement.classList.add('mensaje_element');
            mensajeElement.style.display = 'block';

            if (/\.(jpe?g|png|gif)$/i.test(texto)) {
                const imagen = document.createElement('img');
                imagen.src = texto;
                imagen.style.maxWidth = '40%';
                mensajeElement.appendChild(imagen);
                } else {
                    mensajeElement.textContent = texto;
            }

            nuevoMensaje.appendChild(usernameElement);
            nuevoMensaje.appendChild(saltoLinea);
            nuevoMensaje.appendChild(mensajeElement);

            listaMensajes.appendChild(nuevoMensaje);
            listaMensajes.scrollTop = listaMensajes.scrollHeight;
        }
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Funci√≥n para validar que ambos campos tengan contenido
        function validateInput() {
            const usernameValue = usernameInput.value.trim();
            const messageValue = input.value.trim();

            if (usernameValue !== '' && messageValue !== '') {
                enviarMensaje(usernameValue, messageValue);
                input.value = '';
                cant_caracteres.innerHTML = `Cantidad de Caracteres: 0`;
                mensajeError.style.display = 'none';
            }
        }
        
        enviar.addEventListener('click', validateInput);

        input.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                validateInput();
            }
        });
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Extraer mensajes del api
        let mensajesPrevios = [];

        async function obtenerMensajes() {
            const response = await fetch('https://chat.nrywhite.lat/chats');
            const data = await response.json();

            // Compara los datos nuevos con los almacenados previamente
            if (JSON.stringify(data) !== JSON.stringify(mensajesPrevios)) {
                // Si hay diferencia, actualiza la lista de mensajes
                const listaMensajes = document.getElementById('lista-mensajes');
                listaMensajes.innerHTML = ''; // Limpia los mensajes anteriores

                data.forEach(({ username, message }) => {
                    renderMensaje(username, message);
                });

                mensajesPrevios = data; // Actualiza la variable con los datos actuales
            }
        }

        obtenerMensajes(); //Que se cargue al cargar el DOM
      
        // Cargar mensajes cada 5 segundos, si, hubieron cambios en la base de datos
        setInterval(obtenerMensajes, 5000);
        // /////////////////////////////////////////////////////////////////////////////////

        // /////////////////////////////////////////////////////////////////////////////////
        // Agregar mensaje a la lista con usuario y mensaje al api
        // Funci√≥n para enviar mensaje al API y renderizarlo
        async function enviarMensaje(username, texto) {
            const response = await fetch('https://chat.nrywhite.lat/chats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, message: texto })
            });

            if (response.status === 201) {
                console.log('Mensaje enviado con √©xito');
                renderMensaje(username, texto);
            } else {
                console.error('Error al enviar el mensaje');
            }
        }
        // /////////////////////////////////////////////////////////////////////////////////
    </script>
  </body>
</html>